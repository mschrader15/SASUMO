Metadata:
  # The name will also show up as the main folder for simulation 
  name: Distro_Width+Random_Seed+Apparent_Decel+Sim_Step+Emissions_Device
  author: mcschrader@crimson.ua.edu
  output: ${oc.env:SENSITIVITY_ANALYSIS_OUTPUT}/${Metadata.name}/${datetime:now}
  run_id: ???
  cwd: ${.output}/${.run_id}
  simulation_root: ${oc.env:AIRPORT_HARPER_SUMO}
  random_seed: ${SensitivityAnalysis.Variables.RandomSeed.val}
  mode: SensitivityAnalysis

SensitivityAnalysis:
  parallel_trials: 60 
  # N from N * (2D + 2) samples, should be a power of 2
  N: 64
  calc_second_order: True
  preprocessing: None
  ManagerFunction: 
    module: functions.RemoteEmissionsSUMOFunc
    # sensitivity analysis sample is inherently the first argument 
    arguments:
  
  Variables: 

    DistWidth:
      variable_name: distro_width
      group: ""
      val: ???
      distribution:
        type: uniform
        params:
          lb: .1
          ub: 3

    RandomSeed:
      variable_name: random_seed
      group: ""
      val: ???
      distribution:
        type: uniform
        data_type: int
        params:
          lb: 10
          ub: 10000

    Tau:
      variable_name: tau
      group: car_following_parameter
      val: ??? 
      distribution:
        type: uniform
        params:
          width: ${SensitivityAnalysis.Variables.DistWidth.val}
          lb: 0.2
          ub: 4
 
    Accel:
      variable_name: accel
      group: car_following_parameter
      val: ???
      distribution: 
        type: uniform
        params:
          width: ${SensitivityAnalysis.Variables.DistWidth.val}
          lb: .1
          ub: 6

    speedFactor:
      variable_name: speedFactor
      group: car_following_parameter
      val: ???
      distribution: 
        type: uniform
        params:
          width: .2
          lb: 0.8
          ub: 1.3
   
    minGap:
      variable_name: minGap
      group: car_following_parameter
      val: ???
      distribution: 
        type: uniform
        params:
          width: ${SensitivityAnalysis.Variables.DistWidth.val}
          lb: 0.1
          ub: 6

    # startupDelay:
    #   variable_name: startupDelay
    #   group: car_following_parameter
    #   val: ???
    #   distribution: 
    #     type: uniform
    #     params:
    #       width: ${SensitivityAnalysis.Variables.DistWidth.val}
    #       lb: 0
    #       ub: 3


    # /Distro_Width+Random_Seed/06.01.2022_17.19.09  shows that jmstopline gap does not matter
    # jmStoplineGap:
    #   variable_name: jmStoplineGap
    #   group: car_following_parameter
    #   val: ???
    #   distribution: 
    #     type: uniform
    #     params:
    #       width: ${SensitivityAnalysis.Variables.DistWidth.val}
    #       lb: 0
    #       ub: 5

    EmissionDeviceProbability:
      variable_name: emission_probability
      group: ""
      val: ???
      distribution: 
        type: uniform
        params:
          lb: .05
          ub: 1
    
    SimStep:
      # this will be divided by 10 on the simulation side
      variable_name: sim_step
      group: ""
      val: ???
      distribution: 
        type: uniform
        data_type: math.floor
        data_transform: "[.1, .2, .5, 1][val]"
        params:
          lb: 0
          ub: 4
    
    # CFModel:
    #   variable_name: cfmodel 
    #   group: ""
    #   val: ???
    #   distribution: 
    #     type: uniform
    #     data_type: float
    #     data_transform: "['EIDM', 'IDM'][val > 0]"
    #     params:
    #       lb: -1
    #       ub: 1

  Generators:
    - function: create_veh_distribution
      output_name: veh_distribution_file
      passed_to_simulation: True
      arguments:
        args:
          - ${group:car_following_parameter}
        kwargs:
          output_file_name: ${Metadata.cwd}/__temp__vehDist.in.xml
          distribution_size: 1000
          distribution_common: 
            car_following_parameter:
              distribution_name: vehDist
              distribution_parameters: |
                length;uniform(4,6)
                vClass;passenger
                carFollowModel;IDM
                emissionClass;PHEMlight/PC_G_EU4
                jmDriveAfterYellowTime; uniform(0, 2)
                lcCooperative; normal(1, 0.1);
                lcKeepRight; normal(1, 0.1)
                lcPushy;normal(0.2, 0.1)
                decel; lognormal(2.225, 1.849); [0.1, 8]
                actionStepLength; 0.2
                jmTimegapMinor; 4.5
                impatience; uniform(0, 0.1)

  Output: 
    module: functions.output.TotalEmissionsHandler
    arguments:
      kwargs:
        emissions_xml: ${Metadata.cwd}/__temp__emissions.out.xml
        output_time_filter_lower: 1800
        output_time_filter_upper: 10800
        sim_step: ${SensitivityAnalysis.Variables.SimStep.val}
        save_output: True
        emission_device_probability: ${SensitivityAnalysis.Variables.EmissionDeviceProbability.val}

  PostProcessing:
    module: tools.output_tools.USDOTCalibration
    path: ${Metadata.simulation_root}
    arguments:
      kwargs:
        settings: ${Metadata.cwd}/simulation_params.json
        historical_data: ${Metadata.simulation_root}/data-analysis/feb_2020/detector_average_table_600S.pkl
        save_path: ${Metadata.cwd}/calibration_results.json
    
SimulationCore:
  preprocessing: None
  output_path: ${Metadata.cwd}

  SimulationFunction:  
      module: runners.sasumo.NoTraciSimulationSASUMO
      path: ${Metadata.simulation_root}
      arguments: # Not including the generator arguments marked for being passed to simulation
        kwargs:
          settings: ${Metadata.simulation_root}/sim-settings/sasumo/02_24_20-Coordinated.json
          simulation_output_path: ${SimulationCore.output_path}
          emissions_file_name: ${SensitivityAnalysis.Output.arguments.kwargs.emissions_xml}
          seed: ${Metadata.random_seed}
          sim_step: ${SensitivityAnalysis.Variables.SimStep.val}
          emission_device_probability: ${SensitivityAnalysis.Variables.EmissionDeviceProbability.val}
        
FileManager:
  - None





